@echo off
setlocal EnableExtensions EnableDelayedExpansion

SET /A COUNT=0

COPY LIST.TXT IN.TXT>NUL
ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
ECHO LOCK>LOCK_REQ_BY_INPUT.TXT
IF EXIST LOCK_REQ_BY_INPUT.TXT (
	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
:WAIT1
	IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT1
)
ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
:WAIT2
CALL :TEST quit
TIMEOUT 1 >NUL
IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT2
EXIT /B


for /f "tokens=*" %%G in (LIST.TXT) do (
	call :TEST %%G
)
CALL :TEST quit
PAUSE
EXIT /B

:TEST

IF EXIST LOCK_REQ_BY_INPUT.TXT (
	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
:WAIT1
	IF EXIST LOCK_REQ_BY_INPUT.TXT GOTO :WAIT1
)

SET /A COUNT=!COUNT! + 1

if %1 == quit (
	ECHO quit>>IN.TXT
	ECHO quit>QUIT.TXT
	ECHO ACKNOWLEDGED>LOCK_ACK_BY_OUTPUT.TXT
	EXIT /B
)

ECHO %1.!COUNT!>>IN.TXT
ECHO %1 !COUNT!

EXIT /B
